#******************************************************************************
#
# T O O L   M A K E F I L E
#
#******************************************************************************

THE_TOOL = yplusestimator
THE_LIB = yplus.a

MAINDIR = ../../
include ../../Makefile.defs

SRC= $(shell ls `cat srcfiles.mk`)
OBJ= $(SRC:.f90=.o)

all: builddeps
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	@echo ' COMPILING $(THE_TOOL) ...'
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	$(MAKE) $(THE_LIB)
	$(FC) $(FCFLAGS) -I$(MAINDIR)src -c $(THE_TOOL).f90 -o $(THE_TOOL).o
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	@echo ' $(THE_TOOL) COMPILED, NOW LINKING...'
	@echo '----------------------------------------------------------------------------------------'
	$(FC) $(FLFLAGS) $(THE_TOOL).o $(MAINDIR)lib/$(THE_LIB) -o $(MAINDIR)bin/$(THE_TOOL)
	@echo '----------------------------------------------------------------------------------------'
	@echo ' $(THE_TOOL) LINKED!'
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'

builddeps:
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	@echo ' BUILD DEPENDENCIES FOR TOOL $(THE_TOOL)' 
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	@echo $(SRC) | sed -e 's/ /\n/g' > srcfiles_pp.mk
	@python ../builddeps/builddeps --source=srcfiles_pp.mk deplist.mk
	@rm srcfiles_pp.mk

$(THE_LIB): $(OBJ)
	$(AR) $(AR_FLAGS) $(MAINDIR)lib/$(THE_LIB) $(OBJ)

%.o: %.f90
	$(FC) $(FCFLAGS) -I$(MAINDIR)src -c $< -o $@

#------------------------------------------------------------------------------
# DEPENDENCIES
#------------------------------------------------------------------------------

include deplist.mk

#------------------------------------------------------------------------------
# UTILITY TARGETS
#------------------------------------------------------------------------------
.PHONY: clean veryclean

clean:
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	@echo ' CLEAN UP TOOL $(THE_TOOL)' 
	@echo '~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'
	rm -f $(OBJ) *.mod $(THE_TOOL).o *.i

veryclean: clean
	rm -f *~ */*~
